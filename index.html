<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WVSU Pototan Campus | OJT Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .wvsu-blue { background-color: #003366; }
        .hidden { display: none; }
        #dashboard-screen, #login-screen { transition: opacity 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 flex flex-col items-center font-sans">

    <div id="login-screen" class="w-full max-w-sm bg-white rounded-[2rem] shadow-2xl overflow-hidden my-auto">
        <div class="wvsu-blue p-10 text-center">
            <h1 class="text-white text-xl font-black leading-tight">West Visayas State University</h1>
            <p class="text-blue-200 text-[12px] font-bold uppercase tracking-widest mt-1">Pototan Campus</p>
            <p class="text-white/50 text-[9px] mt-4 uppercase tracking-[0.2em]">OJT Student Portal</p>
        </div>
        <div class="p-8 space-y-4">
            <input type="text" id="login-id" placeholder="WVSU ID Number" class="w-full p-4 bg-slate-50 border rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
            <input type="text" id="login-name" placeholder="Full Name" class="w-full p-4 bg-slate-50 border rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="handleLogin()" class="w-full wvsu-blue text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all">LOGIN</button>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden w-full max-w-sm bg-white rounded-[2.5rem] shadow-2xl overflow-hidden">
        <div class="wvsu-blue p-8 text-white">
            <h2 class="text-lg font-black italic opacity-80">GeoLog System</h2>
            <div class="mt-4">
                <p id="user-display-name" class="text-xl font-bold leading-tight">---</p>
                <p id="user-display-id" class="text-xs text-blue-300 font-mono mt-1">ID: ---</p>
            </div>
        </div>

        <div class="p-8">
            <div id="status-box" class="bg-slate-50 p-4 rounded-2xl text-[10px] font-bold mb-6 text-center border-2 border-dashed border-slate-200">
                üõ∞Ô∏è Waiting for GPS Verification
            </div>

            <div class="grid grid-cols-2 gap-2 mb-8">
                <button onclick="attendance('IN')" id="btn-in" class="wvsu-blue text-white font-bold py-5 rounded-2xl shadow-lg active:scale-95">CLOCK IN</button>
                <button onclick="attendance('OUT')" id="btn-out" class="bg-rose-600 text-white font-bold py-5 rounded-2xl shadow-lg active:scale-95">CLOCK OUT</button>
            </div>

            <div class="border-t border-slate-100 pt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Attendance History</h3>
                    <button onclick="downloadDTR()" class="text-[8px] text-blue-600 font-bold uppercase">Export DTR</button>
                </div>
                <div id="history-list" class="space-y-3"></div>
            </div>

            <button onclick="fastLogout()" class="w-full mt-10 text-slate-400 text-[10px] font-bold uppercase tracking-[0.3em] text-center hover:text-rose-500">Logout</button>
        </div>
    </div>

    <script>
        // GPS Target: Pototan Office
        const TARGET = { lat: 10.945231, lng: 122.641032, radius: 250 };

        function handleLogin() {
            const id = document.getElementById('login-id').value;
            const name = document.getElementById('login-name').value;
            if (id && name) {
                sessionStorage.setItem('sid', id);
                sessionStorage.setItem('sname', name);
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.remove('hidden');
                document.getElementById('user-display-name').innerText = name;
                document.getElementById('user-display-id').innerText = "WVSU ID: " + id;
                renderLogs();
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function attendance(type) {
            const status = document.getElementById('status-box');
            status.innerHTML = "üåÄ Verifying Location...";
            
            navigator.geolocation.getCurrentPosition((pos) => {
                const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, TARGET.lat, TARGET.lng);
                if (dist <= TARGET.radius) {
                    const now = new Date();
                    const log = {
                        type: type,
                        date: now.toLocaleDateString(),
                        time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        raw: now.getTime()
                    };

                    const id = sessionStorage.getItem('sid');
                    let logs = JSON.parse(localStorage.getItem('wvsu_pototan_' + id)) || [];
                    logs.unshift(log);
                    localStorage.setItem('wvsu_pototan_' + id, JSON.stringify(logs));

                    status.innerHTML = `‚úÖ ${type}: ${log.time}`;
                    status.className = "bg-green-50 text-green-700 p-4 rounded-2xl text-[10px] font-bold mb-6 border-2 border-green-200 text-center";
                    renderLogs();
                } else {
                    alert("Out of range! You must be at the Pototan Campus office.");
                }
            }, (err) => alert("Please enable GPS"), { enableHighAccuracy: true });
        }

        function renderLogs() {
            const id = sessionStorage.getItem('sid');
            const logs = JSON.parse(localStorage.getItem('wvsu_pototan_' + id)) || [];
            const container = document.getElementById('history-list');
            
            const grouped = {};
            // Sorting to find multiple In/Out pairs per day
            logs.forEach(l => {
                if (!grouped[l.date]) grouped[l.date] = { date: l.date, ins: [], outs: [] };
                if (l.type === 'IN') grouped[l.date].ins.push(l.raw);
                if (l.type === 'OUT') grouped[l.date].outs.push(l.raw);
            });

            container.innerHTML = Object.values(grouped).map(day => {
                // Calculation for daily hours
                let totalMs = 0;
                const sortedIns = day.ins.sort();
                const sortedOuts = day.outs.sort();
                
                for(let i=0; i < sortedIns.length; i++) {
                    if(sortedOuts[i]) totalMs += (sortedOuts[i] - sortedIns[i]);
                }

                const hrs = Math.floor(totalMs / 3600000);
                const mins = Math.floor((totalMs % 3600000) / 60000);

                return `
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between text-[10px] font-black border-b pb-2 mb-2">
                        <span>${day.date}</span>
                        <span class="text-blue-700">TOTAL: ${hrs}h ${mins}m</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-[10px]">
                        <div class="text-blue-600 font-bold">IN: ${day.ins.length > 0 ? new Date(Math.max(...day.ins)).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--'}</div>
                        <div class="text-rose-600 font-bold text-right">OUT: ${day.outs.length > 0 ? new Date(Math.max(...day.outs)).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--'}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function downloadDTR() {
            const id = sessionStorage.getItem('sid');
            const name = sessionStorage.getItem('sname');
            const logs = JSON.parse(localStorage.getItem('wvsu_pototan_' + id)) || [];
            let content = `WEST VISAYAS STATE UNIVERSITY - POTOTAN CAMPUS\nOJT DTR REPORT\n\nNAME: ${name}\nID: ${id}\n\n`;
            content += `DATE       | TYPE | TIME\n--------------------------\n`;
            logs.forEach(l => { content += `${l.date} | ${l.type.padEnd(4)} | ${l.time}\n`; });
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `DTR_${name.replace(/\s+/g, '_')}.txt`;
            a.click();
        }

        function fastLogout() {
            document.getElementById('dashboard-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-id').value = "";
            document.getElementById('login-name').value = "";
            sessionStorage.clear();
        }
    </script>
</body>
</html>
